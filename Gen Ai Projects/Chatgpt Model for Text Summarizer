pip install transformers accelerate datasets

pip install transformers accelerate datasets

from datasets import load_dataset
multinews = load_dataset('multi_news',split='test')

multinews.to_pandas()

from transformers import AutoTokenizer
tokenizer = AutoTokenizer.from_pretrained('t5-small')

multi_news = multinews.train_test_split(test_size = .2)

prefix = 'summarize:'

def process_function(examples):

    inputs = [prefix + doc for doc in examples['document']]
    model_inputs = tokenizer(inputs, max_length=1024, truncation = True)
    labels = tokenizer(text = examples['summary'], max_length = 128, truncation = True)
    model_inputs['labels'] = labels['input_ids']

    return model_inputs

tokenized_multi_news = multi_news.map(process_function, batched= True)

from transformers import DataCollatorForSeq2Seq, AutoModelForSeq2SeqLM, Seq2SeqTrainingArguments , Seq2SeqTrainer
data_collator = DataCollatorForSeq2Seq(tokenizer = tokenizer, model='t5_small')
model = AutoModelForSeq2SeqLM.from_pretrained('t5-small')

training_args = Seq2SeqTrainingArguments(
    output_dir = "./results",
    eval_strategy = 'epoch',
    learning_rate = 2e-5,
    per_device_train_batch_size = 10,
    per_device_eval_batch_size = 10,
    weight_decay = .01,
    save_total_limit = 3,
    num_train_epochs = 10,
    fp16 = True,
)

from transformers import Seq2SeqTrainer

trainer = Seq2SeqTrainer(
    model=model,
    args=training_args,
    train_dataset=tokenized_multi_news["train"],
    eval_dataset=tokenized_multi_news["test"],
    tokenizer=tokenizer,
    data_collator=data_collator
)

import os
os.environ["WANDB_DISABLED"] = "true"

trainer.train()

text = '''
The Avengers are a team of superheroes and the protagonists of the Marvel Cinematic Universe (MCU) media franchise, based on the eponymous team from Marvel Comics created by Stan Lee and Jack Kirby in 1963. 
Founded by S.H.I.E.L.D. director Nick Fury, the team is a United States–based organization composed primarily of superpowered and gifted individuals, described as "Earth's Mightiest Heroes", 
who are committed to the world's protection from a variety of threats.

The Avengers are depicted as operating in the state of New York: originally from the Avengers Tower in Midtown Manhattan and subsequently in the Avengers Compound in Upstate New York. 
Arranged as an ensemble of core MCU characters originally consisting of Tony Stark / Iron Man, Steve Rogers / Captain America, Thor Odinson, Bruce Banner / Hulk, Natasha Romanoff / Black Widow, 
and Clint Barton / Hawkeye, it later expands to include 17 total members.

Regarded as an important part of the franchise, they are central to the MCU's first 23 films, collectively known as the Infinity Saga. Avengers teams from alternate universes were depicted in subsequent 
MCU properties across the Multiverse Saga, including appearances in the Disney+ animated series What If...? (2021–2024) and Doctor Strange in the Multiverse of Madness (2022). A new incarnation of the 
Avengers is set to return in Avengers: Doomsday (2026) and Avengers: Secret Wars (2027). Both films will be part of the MCU's Phase Six, concluding the Multiverse Saga.

Following the formation of Marvel Studios as an independent film studio by Avi Arad, the head of Marvel's film division, producer Kevin Feige envisioned creating a shared cinematic universe to introduce
the Avengers, similar to Stan Lee and Jack Kirby's comic books in the 1960s. Once Feige became studio chief in 2007 and formed his creative team, his strategy involved creating individual films for each 
major character in Phase One, beginning with Iron Man (2008) and concluding with The Avengers (2012). Casting for the original six members occurred from 2006 to 2010, beginning with Robert Downey 
Jr. as Iron Man and concluding with Mark Ruffalo replacing Edward Norton as the Hulk by 2010. Successive MCU installments introduced new members, with actors from other MCU films reprising their roles.
Following the financial and critical success of The Avengers, a sequel, Avengers: Age of Ultron (2015), was subsequently developed, with Aaron Taylor-Johnson and Elizabeth Olsen joining as Pietro and Wanda Maximoff,
respectively. Captain America: Civil War (2016) was influenced by the "Civil War" comic storyline, depicting the breakup of the Avengers and introducing Tom Holland as Peter Parker / Spider-Man. 
Avengers: Infinity War (2018) and Avengers: Endgame (2019) concluded the Infinity Saga and depicted their disbandment. The film Captain America: Brave New World (2025) depicts the team restarting
under the leadership of Anthony Mackie's Sam Wilson / Captain America, while the film Thunderbolts* (2025) sees members of the Thunderbolts team form a separate faction dubbed the "New Avengers".'''

input_ids = tokenizer(text,max_length= 1024,truncation = True, return_tensors= 'pt').input_ids
input_ids = input_ids.to('cuda')

import torch
with torch.no_grad():
    if model.device.type == 'cuda':
        output = model.generate(input_ids, max_length = 135,num_beams = 5)

summary_ids = output[0].tolist()

summary = tokenizer.decode(summary_ids, skip_special_tokens = True)
print(summary)

summary

ref_summary = '''The Avengers are a group of superheroes and protagonists in the Marvel Cinematic Universe (MCU),
based on the comic books created by Stan Lee and Jack Kirby in 1963. They are primarily superpowered individuals 
committed to protecting the world from various threats. The Avengers operate in New York, with a core group
consisting of Tony Stark, Steve Rogers, Thor Odinson, Bruce Banner, Natasha Romanoff, and Clint Barton. 
They are central to the MCU's first 23 films, known as the Infinity Saga. The Avengers teams from alternate
universes were featured in subsequent MCU properties, including the Disney+ animated series What If...? and
Doctor Strange in the Multiverse of Madness. A new incarnation of the Avengers is set to return in Avengers:
Doomsday and Avengers: Secret Wars, part of the MCU's Phase Six, concluding the Multiverse Saga.'''

pip install rouge

from rouge import Rouge

rouge = Rouge()
scores = rouge.get_scores(summary,ref_summary)
scores

trainer.save_model()

model.save_pretrained('summarizer')
